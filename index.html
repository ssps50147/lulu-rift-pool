<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è£‚ç¸«æ°´æ± ï¼šé¹¿ç²‰æ’ˆæ’ˆç¥­ï¼ˆä¼‘é–’è¼•éŸ³æ¨‚ç‰ˆï¼‰</title>

  <style>
    :root{
      --card:rgba(255,255,255,.62);
      --ink:rgba(10,18,32,.86);
      --ink2:rgba(10,18,32,.62);
      --white:rgba(255,255,255,.92);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r: 18px;
    }
    html,body{
      height:100%;margin:0;
      background: radial-gradient(1200px 700px at 50% 20%, #1a325a 0%, #081225 55%, #050b16 100%);
      color:var(--white);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      overflow:hidden;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }
    .wrap{height:100%; display:grid; place-items:center; padding:14px;}
    .frame{
      position:relative;
      width:min(980px, 100%);
      aspect-ratio:16/9;
      max-height: calc(100vh - 28px);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      background: radial-gradient(circle at 50% 25%, #a7f3ff 0%, #2aa6ff 28%, #0b6ea8 55%, #063254 100%);
    }
    canvas{width:100%; height:100%; display:block; touch-action:none;}

    .hud{
      position:absolute; inset:14px 14px auto 14px;
      display:flex; gap:12px; align-items:stretch; flex-wrap:wrap;
      pointer-events:none;
      z-index: 10;
    }
    .card{
      background: var(--card);
      color: var(--ink);
      border-radius: var(--r);
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.35);
      min-width: 220px;
    }
    .card b{font-weight:800}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .sub{font-size:12px; color: var(--ink2); margin-top:4px; line-height:1.35;}
    .bar{height:10px; width: 220px; background: rgba(10,18,32,.10); border-radius: 999px; overflow:hidden; margin-top:8px;}
    .bar i{display:block;height:100%;width:100%; background: rgba(255,213,120,.95);}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(10,18,32,.10);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--ink2);
      margin-top:8px;
      flex-wrap:wrap;
    }

    .overlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background: radial-gradient(900px 600px at 50% 30%, rgba(255,255,255,.22) 0%, rgba(0,0,0,.35) 55%, rgba(0,0,0,.55) 100%);
      z-index: 20;
    }
    .panel{
      width: min(680px, 92%);
      background: rgba(255,255,255,.70);
      color: var(--ink);
      border-radius: 24px;
      padding: 18px 18px 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.4);
      backdrop-filter: blur(12px);
    }
    /* âœ… ç©æ³•è¦–çª—ç¸®å° 0.75 */
    .panel.tutorial-shrink{
      transform: scale(0.75);
      transform-origin: center center;
      will-change: transform;
    }

    .title{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    h1{margin:0; font-size: 22px; letter-spacing: .2px;}
    .tag{font-size: 12px; color: var(--ink2); background: rgba(10,18,32,.08); padding:6px 10px; border-radius:999px;}
    .desc{margin: 10px 0 14px; color: var(--ink2); line-height: 1.6; font-size: 14px;}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    button{
      appearance:none; border:0; cursor:pointer;
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 900;
      background: rgba(10,18,32,.85);
      color: rgba(255,255,255,.92);
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
    }
    button.secondary{
      background: rgba(10,18,32,.10);
      color: var(--ink);
      font-weight: 800;
      box-shadow:none;
      border: 1px solid rgba(10,18,32,.12);
    }
    .small{font-size:12px; color: var(--ink2);}
    .rank{
      margin-top: 10px;
      background: rgba(10,18,32,.06);
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(10,18,32,.06);
    }
    .rank h2{margin:0 0 8px; font-size: 14px; color: rgba(10,18,32,.75);}
    .rank ol{margin:0; padding-left: 18px; color: rgba(10,18,32,.72); font-size: 13px; line-height: 1.6;}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: rgba(255,255,255,.6);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(10,18,32,.10);
    }

    .toast{
      position:absolute; left: 16px; top: 86px;
      background: rgba(255,255,255,.72);
      color: rgba(10,18,32,.86);
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.45);
      backdrop-filter: blur(10px);
      max-width: min(760px, calc(100% - 32px));
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      opacity:0; transform: translateY(-6px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      white-space: pre-line;
      z-index: 15;
    }
    .toast.show{opacity:1; transform: translateY(0);}

    .liffbar{
      position:absolute;
      right: 14px;
      top: 14px;
      display:flex;
      gap:10px;
      z-index: 30;
      pointer-events:auto;
    }
    .liffbar button{
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      background: rgba(10,18,32,.72);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
    }
    .hidden{display:none !important;}

    .rotate-hint{
      position:absolute; left:0; right:0; top:0;
      z-index: 60;
      display:none;
      padding: 10px 12px;
      text-align:center;
      font-weight: 900;
      letter-spacing: .4px;
      color: rgba(255,255,255,.96);
      background: linear-gradient(90deg, rgba(0,0,0,.80), rgba(20,30,60,.78), rgba(0,0,0,.80));
      border-bottom: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
    }
    .rotate-hint__inner{
      display:inline-block;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      animation: riftPulse 1.15s ease-in-out infinite;
    }
    .rotate-hint__sub{
      margin-top: 4px;
      font-size: 12px;
      font-weight: 800;
      opacity: .88;
    }
    @keyframes riftPulse{
      0%   { transform: translateY(0) scale(1);   filter: drop-shadow(0 0 0 rgba(255,255,255,.0)); }
      50%  { transform: translateY(1px) scale(1.02); filter: drop-shadow(0 0 10px rgba(180,240,255,.35)); }
      100% { transform: translateY(0) scale(1);   filter: drop-shadow(0 0 0 rgba(255,255,255,.0)); }
    }

    .portrait-lock{
      position:absolute; inset:0;
      z-index:55;
      display:none;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.45);
      place-items:center;
    }
    .portrait-lock__content{
      text-align:center;
      color:#fff;
      font-weight:900;
    }
    .rotate-icon{
      font-size:64px;
      margin-bottom:12px;
      animation: rotatePhone 1.4s ease-in-out infinite;
    }
    .portrait-text{
      font-size:18px;
      line-height:1.5;
      letter-spacing:.5px;
    }
    @keyframes rotatePhone{
      0%{transform:rotate(0deg)}
      25%{transform:rotate(-20deg)}
      50%{transform:rotate(0deg)}
      75%{transform:rotate(20deg)}
      100%{transform:rotate(0deg)}
    }

    @media (max-width: 640px), (max-aspect-ratio: 3/4) {
      .wrap { padding: 0; }
      .frame{
        width: 100vw;
        height: 100dvh;
        max-height: 100dvh;
        aspect-ratio: auto;
        border-radius: 0;
      }
      .hud{ inset: 10px 10px auto 10px; gap: 8px; }
      .card{ min-width: 0; width: 100%; }
      .bar{ width: 100%; }
      .panel{ max-height: 86dvh; overflow:auto; }
      .toast{ top: 120px; left: 10px; right: 10px; max-width: none; }
      .liffbar{ right: 10px; top: 10px; }
    }
    @media (max-height: 520px){
      .panel{ max-height: 82vh; overflow: auto; padding: 14px 14px 12px; }
      h1{ font-size: 18px; }
      .desc{ font-size: 13px; line-height: 1.55; margin: 8px 0 10px; }
      .btns{ margin-top: 10px; }
      button{ padding: 10px 12px; border-radius: 14px; }
    }

    /* ğŸŒ™ é‡‘é­šä¹‹å¤œä¸»é¡Œ */
    body.fish-night .frame{
      background: radial-gradient(circle at 50% 25%, rgba(255,235,190,.95) 0%, rgba(255,179,71,.92) 30%, rgba(140,70,0,.86) 62%, rgba(25,10,0,.95) 100%);
    }
    body.fish-night .card{ border-radius: 22px; }
    body.fish-night .panel{ border-radius: 28px; }
    body.fish-night button{ border-radius: 22px; }
    body.fish-night .panel{
      background: linear-gradient(180deg, rgba(255,240,200,.96), rgba(255,215,140,.92));
      box-shadow: 0 20px 60px rgba(120,70,0,.35), inset 0 0 0 1px rgba(255,255,255,.55);
    }
    body.fish-night .panel h1{ color:#6a3b00; text-shadow: 0 0 10px rgba(255,210,120,.6); }
    body.fish-night .panel b{ color:#8a4b00; }

    .quick-start{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 80;
      pointer-events: auto;
    }
    .quick-start button{
      border-radius: 999px;
      padding: 14px 18px;
      font-weight: 900;
      font-size: 14px;
      background: linear-gradient(135deg, #0a1f3a, #153a6b);
      color: #fff;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.25);
    }
    body.fish-night .quick-start button{
      background: linear-gradient(135deg, #ffdd99, #ffb347);
      color: #5a3200;
      box-shadow: 0 12px 30px rgba(120,70,0,.45);
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="frame">
    <div id="rotateHint" class="rotate-hint" aria-live="polite">
      <div class="rotate-hint__inner">
        ğŸ”’ è¦–ç•Œç©©å®šå”å®šå·²å•Ÿç”¨<br/>
        ç›´å‘è§€æ¸¬å°‡å°è‡´è£‚ç¸«å¹²æ“¾<br/>
        è«‹é¹¿ç²‰çµ±ä¸€ä»¥æ©«å‘è¦–ç•Œé€²å…¥
        <div class="rotate-hint__sub">â€”â€”ç³»çµ±å·²é–å®šï¼ˆç›´å‘ä¸å¯é–‹å§‹ï¼‰</div>
      </div>
    </div>

    <div id="portraitLock" class="portrait-lock" aria-hidden="true">
      <div class="portrait-lock__content">
        <div class="rotate-icon">ğŸ”„</div>
        <div class="portrait-text">
          ğŸ¦’ é¹¿é¹¿æé†’<br/>è«‹å°‡è£ç½®æ©«å‘éŠç©
        </div>
      </div>
    </div>

    <div class="liffbar hidden" id="liffBar">
      <button id="closeBtn" title="é—œé–‰ LIFF è¦–çª—">é—œé–‰</button>
    </div>

    <canvas id="c" width="1280" height="720"></canvas>

    <div class="quick-start" id="quickStart">
      <button>âš¡ å¿«é€Ÿé–‹å§‹</button>
    </div>

    <div class="hud" aria-hidden="true">
      <div class="card">
        <div class="row">
          <div>è£‚ç¸«æ”¶é›†ï¼š<b id="score">0</b></div>
          <div>â³ <b id="time">60</b>s</div>
        </div>
        <div class="sub" id="modeText">æ¨¡å¼ï¼šä¸€èˆ¬</div>
        <div class="pill">
          é€£æ“Šï¼š<b id="combo">0</b>
          é‡‘é­šï¼š<b id="fishCount">0</b>
          ç¨±è™Ÿï¼š<b id="title">æ–°æ‰‹é¹¿ç²‰</b>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div>ç´™ç¶²è€ä¹…ï¼š<b id="durText">100</b></div>
          <div>ç ´ç¶²ï¼š<b id="breaks">0</b></div>
        </div>
        <div class="bar"><i id="durBar"></i></div>
        <div class="sub">æŒ‰ä½ä¸‹ç¶²æ’ˆèµ·ç‰©ä»¶æœƒè€—æï¼›è€ä¹…æ­¸é›¶æœƒç ´ï¼ˆè‡ªå‹•æ›æ–°ï¼‰</div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="overlay" id="overlay">
      <div class="panel" role="dialog" aria-modal="true">
        <div class="title">
          <h1>ğŸŒŒ è£‚ç¸«æ°´æ± ï¼šé¹¿ç²‰æ’ˆæ’ˆç¥­</h1>
          <div class="tag">æœ€çµ‚æ•´åˆç‰ˆ</div>
        </div>

        <div class="desc">
          <b>ç©æ³•</b>ï¼šç§»å‹•ç¶²å­ï¼Œ<b>æŒ‰ä½</b>ä¸‹ç¶²æ’ˆèµ·ç¢ç‰‡/é‡‘é­šå¾—åˆ†ã€‚<br/>
          ç¶²å­æœ‰è€ä¹…ï¼Œæ­¸é›¶æœƒç ´ç¶²ä¸¦è‡ªå‹•æ›æ–°ï¼›<b>60 ç§’</b>çµç®—ã€‚<br/>
          è«‹ä½¿ç”¨<b>æ©«å‘</b>éŠç©ï¼ˆç›´å‘ä¸å¯é–‹å§‹ï¼‰ã€‚<br/>
          éµç›¤ï¼š<span class="kbd">R</span> å¯é‡é–‹ã€‚
        </div>

        <div class="rank">
          <h2>ğŸ† ä»Šæ—¥æ’è¡Œæ¦œï¼ˆTop 5ï¼‰</h2>
          <ol id="rankList"></ol>
        </div>

        <div class="btns">
          <button id="startBtn">é–‹å§‹æ’ˆæ’ˆï¼</button>
          <button class="secondary" id="muteBtn">éŸ³æ•ˆï¼šé–‹</button>
          <button class="secondary" id="resetRankBtn">æ¸…ç©ºä»Šæ—¥æ¦œ</button>
        </div>

        <div class="small" id="resultText" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(() => {
  // âœ…âœ…âœ… åªæ”¹é€™ä¸€è¡Œï¼šå¡«å…¥ä½ çš„ LIFF IDï¼ˆä¸æ˜¯æ•´æ®µ LIFF URLï¼‰
  const LIFF_ID = "2008825801-LXHTWx5N";
  const LS_TUTORIAL_SEEN = "lulu_tutorial_seen_v1";

  // ===== LIFF =====
  const liffBar = document.getElementById('liffBar');
  const closeBtn = document.getElementById('closeBtn');

  async function initLiffAndUi(){
    if(!window.liff || !LIFF_ID || LIFF_ID.includes("PASTE_")) return;
    try{
      await liff.init({ liffId: LIFF_ID });
      if (liff.isInClient && liff.isInClient()) liffBar.classList.remove('hidden');
      closeBtn.addEventListener('click', ()=>{
        if (liff.isInClient && liff.isInClient()) liff.closeWindow();
      });
    }catch(e){
      console.warn("LIFF init failed:", e);
    }
  }
  initLiffAndUi();

  // ===== æ©«å‘é–å®š + ç›´å‘ç¦æ­¢é–‹å§‹ =====
  const rotateHint = document.getElementById("rotateHint");
  const portraitLock = document.getElementById("portraitLock");
  function isPortrait(){ return window.innerHeight > window.innerWidth; }
  async function tryLockLandscape(){
    if (screen.orientation && screen.orientation.lock) {
      try { await screen.orientation.lock("landscape"); } catch(_) {}
    }
  }
  function updateOrientationUI(){
    if (isPortrait()) {
      portraitLock.style.display = "grid";
      rotateHint.style.display = "block";
    } else {
      portraitLock.style.display = "none";
      rotateHint.style.display = "none";
    }
  }
  tryLockLandscape();
  updateOrientationUI();
  window.addEventListener("resize", updateOrientationUI);
  window.addEventListener("orientationchange", updateOrientationUI);

  // ===== Canvas =====
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // ===== UI =====
  const uiScore = document.getElementById('score');
  const uiTime = document.getElementById('time');
  const uiCombo = document.getElementById('combo');
  const uiFishCount = document.getElementById('fishCount');
  const uiTitle = document.getElementById('title');
  const uiDurText = document.getElementById('durText');
  const uiDurBar = document.getElementById('durBar');
  const uiBreaks = document.getElementById('breaks');
  const modeText = document.getElementById('modeText');

  const overlay = document.getElementById('overlay');
  const panel = overlay.querySelector(".panel");
  const startBtn = document.getElementById('startBtn');
  const muteBtn = document.getElementById('muteBtn');
  const resetRankBtn = document.getElementById('resetRankBtn');
  const rankList = document.getElementById('rankList');
  const resultText = document.getElementById('resultText');
  const toast = document.getElementById('toast');
  const quickStart = document.getElementById("quickStart");

  // ===== Helpers =====
  const rand = (a,b)=> a + Math.random()*(b-a);
  const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));
  const dist2 = (ax,ay,bx,by)=> { const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; };

  // ===== Audio Core =====
  let audioOn = true;
  let actx = null;
  function ensureAudio(){
    if(!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
    if(actx && actx.state === "suspended") actx.resume?.();
  }
  function audioOk(){
    if(!audioOn) return false;
    try{ ensureAudio(); return true; }catch(_){ return false; }
  }

  // ===== æ³¡æ³¡å•µå•µï¼ˆé€£æ“Šå‡éŸ³é«˜ï¼Œä½†éŸ³é‡å—æ§ä¸åµï¼‰=====
  let sfxCooldown = 0;
  const SFX_COOLDOWN_MIN = 0.028;
  const SFX_GAIN_CAP = 0.040;
  const SFX_GAIN_BASE = 0.018;

  function stepSfxCooldown(dt){
    if(sfxCooldown > 0) sfxCooldown -= dt;
  }
  function popPitchFromCombo(combo){
    const c = Math.min(30, Math.max(0, combo|0));
    return 1.0 + (c/30) * 0.55;
  }

  function bubblePopCombo(combo, base=520){
    if(!audioOk()) return;
    if(sfxCooldown > 0) return;
    sfxCooldown = SFX_COOLDOWN_MIN;

    const t0 = actx.currentTime;
    const pitch = popPitchFromCombo(combo);

    const freqHi = base * 1.18 * pitch;
    const freqLo = base * 0.82 * pitch;

    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();

    o.type = "sine";
    o.frequency.setValueAtTime(freqHi, t0);
    o.frequency.exponentialRampToValueAtTime(freqLo, t0 + 0.09);

    lp.type = "lowpass";
    lp.frequency.setValueAtTime(1600 + (combo|0)*10, t0);
    lp.Q.value = 0.7;

    const gain = Math.min(SFX_GAIN_CAP, SFX_GAIN_BASE);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.11);

    o.connect(lp); lp.connect(g); g.connect(actx.destination);
    o.start(t0);
    o.stop(t0 + 0.13);
  }

  function bubbleDingCombo(combo){
    if(!audioOk()) return;
    if(sfxCooldown > 0) return;
    sfxCooldown = Math.max(sfxCooldown, 0.04);

    const t0 = actx.currentTime;

    const pitch = popPitchFromCombo(combo);
    const gain = Math.min(SFX_GAIN_CAP, SFX_GAIN_BASE + 0.006);

    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();

    o.type = "triangle";
    const f1 = 640 * pitch;
    const f2 = 920 * pitch;
    o.frequency.setValueAtTime(f1, t0);
    o.frequency.setValueAtTime(f2, t0 + 0.08);

    lp.type = "lowpass";
    lp.frequency.setValueAtTime(2400, t0);
    lp.Q.value = 0.6;

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

    o.connect(lp); lp.connect(g); g.connect(actx.destination);
    o.start(t0);
    o.stop(t0 + 0.20);

    setTimeout(()=> { bubblePopCombo(combo, 700); }, 90);
  }

  function bubbleThud(){
    if(!audioOk()) return;
    if(sfxCooldown > 0) return;
    sfxCooldown = Math.max(sfxCooldown, 0.06);

    const t0 = actx.currentTime;

    const o = actx.createOscillator();
    const g = actx.createGain();
    const lp = actx.createBiquadFilter();

    o.type = "sine";
    o.frequency.setValueAtTime(200, t0);
    o.frequency.exponentialRampToValueAtTime(120, t0 + 0.12);

    lp.type = "lowpass";
    lp.frequency.setValueAtTime(700, t0);
    lp.Q.value = 0.9;

    const gain = Math.min(SFX_GAIN_CAP, 0.032);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.16);

    o.connect(lp); lp.connect(g); g.connect(actx.destination);
    o.start(t0);
    o.stop(t0 + 0.18);
  }

  // ===== å…ä»˜è²»ç’°å¢ƒ BGMï¼ˆä¼‘é–’è¼•éŸ³æ¨‚ï¼šæ˜äº®ã€è¼•é¬†ã€ä¸æ²‰æ‚¶ï¼‰=====
  let freeBgm = null;
  function midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }

  function startFreeBgm(){
    if(!audioOn || freeBgm) return;
    try{
      ensureAudio();

      const master = actx.createGain();
      master.gain.value = 0.0135; // âœ… è¼•é¬†ä½†ä¸åµ
      master.connect(actx.destination);

      const lp = actx.createBiquadFilter();
      lp.type = "lowpass";
      lp.frequency.value = 2400;
      lp.Q.value = 0.55;
      lp.connect(master);

      const stereo = actx.createStereoPanner();
      stereo.pan.value = 0;
      stereo.connect(lp);

      const arpBus = actx.createGain(); arpBus.gain.value = 0.85; arpBus.connect(stereo);
      const leadBus = actx.createGain(); leadBus.gain.value = 0.75; leadBus.connect(stereo);

      const prog = [
        [60, 64, 67], // C
        [67, 71, 74], // G
        [69, 72, 76], // Am
        [65, 69, 72], // F
      ];
      const scale = [60, 62, 64, 67, 69, 72]; // C D E G A C

      const bpm = 120;
      const stepSec = 60 / bpm / 2;
      let step = 0;

      function pluck({freq, dur=0.12, type="triangle", bus=arpBus, bright=2600, gain=0.9, pan=0}){
        const t0 = actx.currentTime;
        const o = actx.createOscillator();
        const g = actx.createGain();
        const f = actx.createBiquadFilter();
        const p = actx.createStereoPanner();

        o.type = type;
        o.frequency.setValueAtTime(freq, t0);

        f.type = "lowpass";
        f.frequency.setValueAtTime(bright, t0);
        f.Q.value = 0.7;

        p.pan.value = pan;

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.008);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

        o.connect(f); f.connect(g); g.connect(p); p.connect(bus);
        o.start(t0);
        o.stop(t0 + dur + 0.02);
      }

      function softKick(){
        const t0 = actx.currentTime;
        const o = actx.createOscillator();
        const g = actx.createGain();
        const f = actx.createBiquadFilter();

        o.type = "sine";
        o.frequency.setValueAtTime(120, t0);
        o.frequency.exponentialRampToValueAtTime(55, t0 + 0.08);

        f.type = "lowpass";
        f.frequency.setValueAtTime(300, t0);
        f.Q.value = 1.0;

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.022, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.10);

        o.connect(f); f.connect(g); g.connect(stereo);
        o.start(t0);
        o.stop(t0 + 0.12);
      }

      function tick(){
        if(!audioOn || !freeBgm) return;

        const bar = Math.floor(step / 16);
        const chord = prog[bar % prog.length];

        const arpPattern = [0, 2, 1, 2, 0, 2, 1, 2];
        const idx = arpPattern[step % arpPattern.length];
        const base = chord[idx];

        const pan = ((step % 8) - 3.5) / 10;
        const octave = (step % 8 === 4 && Math.random() < 0.55) ? 12 : 0;

        pluck({
          freq: midiToFreq(base + octave),
          dur: 0.11,
          type: "triangle",
          bus: arpBus,
          bright: 2600,
          gain: 0.78,
          pan
        });

        if(step % 4 === 2 && Math.random() < 0.82){
          const s = scale[(Math.random() * scale.length) | 0];
          const jump = (Math.random() < 0.18) ? 12 : 0;
          pluck({
            freq: midiToFreq(s + jump),
            dur: 0.14,
            type: "sine",
            bus: leadBus,
            bright: 3200,
            gain: 0.55,
            pan: -pan * 0.6
          });
        }

        if(step % 4 === 0 && Math.random() < 0.85){
          softKick();
        }

        step++;
        freeBgm.timer = setTimeout(tick, Math.round(stepSec * 1000));
      }

      freeBgm = { master, lp, stereo, arpBus, leadBus, timer:null };
      tick();
    }catch(_){}
  }

  function stopFreeBgm(){
    if(!freeBgm) return;
    try{
      if(freeBgm.timer) clearTimeout(freeBgm.timer);
      const t0 = actx.currentTime;
      freeBgm.master.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
      setTimeout(()=>{ freeBgm = null; }, 220);
    }catch(_){
      freeBgm = null;
    }
  }

  // ğŸŒ™ å¤œé–“éŸ³
  function nightBell(){
    if(!audioOn) return;
    try{
      ensureAudio();
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(880, actx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1320, actx.currentTime + 0.25);
      g.gain.setValueAtTime(0.0001, actx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.035, actx.currentTime + 0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + 0.6);
      o.connect(g); g.connect(actx.destination);
      o.start(); o.stop(actx.currentTime + 0.65);
    }catch(_){}
  }
  let nightBgm = null;
  function startNightBgm(){
    if(!audioOn || nightBgm) return;
    try{
      ensureAudio();
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type = "sine";
      o.frequency.value = 110;
      g.gain.value = 0.008;
      o.connect(g); g.connect(actx.destination);
      o.start();
      nightBgm = {o,g};
    }catch(_){}
  }
  function stopNightBgm(){
    if(nightBgm){
      try{ nightBgm.o.stop(); }catch(_){}
      nightBgm = null;
    }
  }

  // ===== æ™‚æ®µ =====
  const FRENZY_START_H = 12, FRENZY_END_H = 14;
  const FISH_START_H = 19,   FISH_END_H   = 21;
  function isFrenzy(d){ const h=d.getHours(); return h>=FRENZY_START_H && h<FRENZY_END_H; }
  function isFishNight(d){ const h=d.getHours(); return h>=FISH_START_H && h<FISH_END_H; }

  function updateModeUI(d){
    let mode="ä¸€èˆ¬", extra="";
    if(isFishNight(d)){ mode="é‡‘é­šä¹‹å¤œ"; extra=""; }
    else if(isFrenzy(d)){ mode="è£‚ç¸«æš´èµ°"; extra="ç¢ç‰‡å¯†åº¦â†‘ãƒ»å¾—åˆ†å€ç‡â†‘"; }
    modeText.textContent = extra ? `æ¨¡å¼ï¼š${mode}ï½œ${extra}` : `æ¨¡å¼ï¼š${mode}`;
  }

  // ===== æ•´é»äº‹ä»¶ =====
  let lastHourlyStamp = "";
  function hourlyStamp(d){
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}-${d.getHours()}`;
  }
  const hourlyHintPool = [
    "ğŸ•³ï¸ æ•´é»æ¢ç´¢æç¤º\nè£‚ç¸«åœ¨å‘¼å¸ã€‚ç¢ç‰‡æœƒæ›´é è¿‘æ°´é¢ã€‚",
    "ğŸ›°ï¸ æ•´é»æ¢ç´¢æç¤º\nç³»çµ±æƒæä¸­â€¦é¹¿ç²‰è«‹ä¿æŒå†·éœã€‚",
    "ğŸ‘€ æ•´é»æ¢ç´¢æç¤º\nåå‘æ¨™è¨˜é¢¨éšªä¸Šå‡ï¼ˆä½†çå‹µä¹Ÿä¸Šå‡ï¼‰ã€‚",
    "âœ¨ æ•´é»æ¢ç´¢æç¤º\nå›è²ç¢ç‰‡å‡ºç¾ç‡çŸ­æš«æå‡ï¼",
    "ğŸŒŒ æ•´é»æ¢ç´¢æç¤º\né¹¿é¹¿æŠ¬é ­çœ‹äº†ä¸€ç§’ï¼šã€ä¾†äº†ã€‚ã€",
    "ğŸ“¡ æ•´é»æ¢ç´¢æç¤º\nä½ è½åˆ°æ¥µè¼•çš„å—¡é³´è²â€”â€”ä¸è¦æŠ¬é ­ã€‚"
  ];
  let echoBoostTimer = 0;

  // ===== æ’è¡Œæ¦œï¼ˆåªä¿ç•™ä»Šå¤©ï¼‰ =====
  const LS_KEY = "lulu_rank_today_v1";
  function todayKeyLocal(){
    const d = new Date();
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function pruneToToday(arr){
    const today = todayKeyLocal();
    return (arr || []).filter(x => x && x.dayKey === today);
  }
  function loadRank(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return pruneToToday(Array.isArray(arr) ? arr : []);
    }catch(_){ return []; }
  }
  function saveRank(arr){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(pruneToToday(arr).slice(0,40))); }catch(_){}
  }
  function renderRank(){
    const arr = loadRank().slice(0,5);
    rankList.innerHTML = "";
    if(arr.length===0){
      const li=document.createElement("li");
      li.textContent="ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»æ’ˆç¬¬ä¸€åï¼";
      rankList.appendChild(li);
      return;
    }
    for(const r of arr){
      const li=document.createElement("li");
      li.textContent = `${r.score} åˆ† ${r.night ? "ğŸŒ™" : ""}ï¼ˆç ´ç¶² ${r.breaks}ï½œæœ€é«˜é€£æ“Š ${r.maxCombo}ï½œé‡‘é­š ${r.fishHits}ï¼‰`;
      rankList.appendChild(li);
    }
  }

  // ===== Toast =====
  let toastTimer = 0;
  function showToast(text){
    toast.textContent = text;
    toast.classList.add("show");
    toastTimer = 3.0;
  }

  // ===== éŠæˆ²ç‹€æ…‹ =====
  const maxDurability = 100;
  const GAME_SECONDS = 60;

  let running=false, timeLeft=GAME_SECONDS, score=0;
  let combo=0, maxCombo=0, breaks=0, fishHits=0;
  let lastFishNight=false;

  const pointer = { x: W*0.5, y: H*0.55, pressed:false };
  const net = { x:pointer.x, y:pointer.y, r:38, down:false, durability:maxDurability, broken:false, cooldown:0 };

  const shardTypes = [
    { key:"stardust", name:"æ˜Ÿå±‘", score:1, dmg:[4,7],  rarity:0.70, color:"rgba(255,244,198,.95)", glow:"rgba(255,255,255,.75)" },
    { key:"prism",    name:"æ£±æ™¶", score:2, dmg:[7,12], rarity:0.23, color:"rgba(222,210,255,.95)", glow:"rgba(210,255,250,.55)" },
    { key:"echo",     name:"å›è²", score:3, dmg:[10,16],rarity:0.07, color:"rgba(188,255,235,.95)", glow:"rgba(255,255,255,.85)" }
  ];

  function pickShardType(){
    const boost = echoBoostTimer > 0;
    const weights = shardTypes.map(t => {
      let w=t.rarity;
      if(boost && t.key==="echo") w*=2.2;
      if(boost && t.key==="stardust") w*=0.9;
      return w;
    });
    const total = weights.reduce((a,b)=>a+b,0);
    let r=Math.random()*total;
    for(let i=0;i<shardTypes.length;i++){
      r -= weights[i];
      if(r<=0) return shardTypes[i];
    }
    return shardTypes[0];
  }

  function makeShard(){
    const t = pickShardType();
    const baseSp = rand(24, 36);
    const ang = rand(0, Math.PI*2);
    return {
      kind:"shard",
      type:t,
      x: rand(80, W-80),
      y: rand(120, H-90),
      vx: Math.cos(ang)*baseSp,
      vy: Math.sin(ang)*baseSp*0.55,
      r: rand(10, 14),
      tw: rand(0, Math.PI*2),
      alive:true,
      hourly:false
    };
  }

  function makeHourlyEchoShard(){
    const baseSp = rand(24, 36);
    const ang = rand(0, Math.PI*2);
    return {
      kind:"shard",
      type:{ key:"echo_hourly", name:"å›è²Â·æ•´é»", score:4, dmg:[12,18], color:"rgba(210,255,245,.98)", glow:"rgba(255,255,255,.92)" },
      x: rand(100, W-100),
      y: rand(140, H-110),
      vx: Math.cos(ang)*baseSp,
      vy: Math.sin(ang)*baseSp*0.55,
      r: rand(12, 16),
      tw: rand(0, Math.PI*2),
      alive:true,
      hourly:true
    };
  }

  function makeFish(){
    const baseSp = rand(70, 95);
    const ang = rand(0, Math.PI*2);
    return { kind:"fish", x:rand(90,W-90), y:rand(140,H-90), vx:Math.cos(ang)*baseSp, vy:Math.sin(ang)*baseSp*0.55, r:rand(18,22), wiggle:rand(0,Math.PI*2), alive:true };
  }

  const shards = [];
  let fish = null;

  const pops = [];
  function spawnPop(x,y,text){
    const night = document.body.classList.contains("fish-night");
    pops.push({x,y,vy:-30,t:0.7,text,night});
  }

  function scoreMult(d){ return isFrenzy(d) ? 1.25 : 1.0; }

  function titleFromScore(s){
    if(s >= 110) return "è£‚ç¸«è§€æ¸¬å“¡";
    if(s >= 80)  return "ç¢ç‰‡æ”¶é›†å¸«";
    if(s >= 50)  return "ç†Ÿç·´é¹¿ç²‰";
    if(s >= 28)  return "è¦‹ç¿’é¹¿ç²‰";
    return "æ–°æ‰‹é¹¿ç²‰";
  }
  function displayTitle(s){
    const base = titleFromScore(s);
    return document.body.classList.contains("fish-night") ? `å¤œé–“è§€æ¸¬å“¡ Â· ${base}` : base;
  }

  function setDurUI(){
    uiDurText.textContent = Math.round(net.durability);
    uiDurBar.style.width = `${(net.durability/maxDurability)*100}%`;
  }

  function resetGame(){
    running=true;
    timeLeft=GAME_SECONDS;
    score=0; combo=0; maxCombo=0; breaks=0; fishHits=0;

    net.x=W*0.5; net.y=H*0.55;
    net.down=false;
    net.durability=maxDurability;
    net.broken=false;
    net.cooldown=0;

    shards.length=0;
    for(let i=0;i<10;i++) shards.push(makeShard());
    fish=null;
    pops.length=0;

    echoBoostTimer=0;
    lastHourlyStamp="";

    uiScore.textContent=score;
    uiTime.textContent=timeLeft;
    uiCombo.textContent=combo;
    uiFishCount.textContent=fishHits;
    uiBreaks.textContent=breaks;
    uiTitle.textContent=displayTitle(score);
    setDurUI();
    updateModeUI(new Date());

    quickStart.style.display = "none";

    // âœ… éŠæˆ²ä¸­æ’­æ”¾ã€Œä¼‘é–’è¼•éŸ³æ¨‚ã€ç’°å¢ƒBGM
    startFreeBgm();

    showToast("é¹¿é¹¿ï¼šç¢ç‰‡å°±äº¤çµ¦ä½ äº†ã€‚");
  }

  function endGame(){
    running=false;
    stopFreeBgm();

    const night = document.body.classList.contains("fish-night");
    const arr = loadRank();
    arr.push({ dayKey: todayKeyLocal(), score, breaks, maxCombo, fishHits, night, ts: Date.now() });
    arr.sort((a,b)=> b.score-a.score || a.breaks-b.breaks || b.maxCombo-a.maxCombo);
    saveRank(arr);
    renderRank();

    resultText.innerHTML = `çµç®—ï¼š<b>${score}</b> åˆ†ï½œç ´ç¶² <b>${breaks}</b> æ¬¡ï½œæœ€é«˜é€£æ“Š <b>${maxCombo}</b>ï½œé‡‘é­š <b>${fishHits}</b>ï½œç¨±è™Ÿï¼š<b>${displayTitle(score)}</b>${night ? " <b>ğŸŒ™</b>" : ""}`;
    overlay.style.display="grid";

    panel.classList.remove("tutorial-shrink");
    quickStart.style.display = "block";
  }

  function triggerHourlyEvent(){
    const msg = hourlyHintPool[(Math.random()*hourlyHintPool.length)|0];
    echoBoostTimer = 12;
    shards.push(makeHourlyEchoShard());
    bubbleDingCombo(combo);
    showToast(msg + "\nâœ¨æ•´é»å›è²ç¢ç‰‡å·²åˆ·æ–°ï¼");
  }

  function catchShard(s, nowDate){
    s.alive=false;

    const add = Math.round(s.type.score * scoreMult(nowDate));
    score += add;

    uiScore.textContent=score;
    uiTitle.textContent=displayTitle(score);

    combo += 1;
    maxCombo = Math.max(maxCombo, combo);
    uiCombo.textContent=combo;

    net.durability -= rand(s.type.dmg[0], s.type.dmg[1]);
    spawnPop(s.x, s.y, `+${add}`);

    if(s.type.key==="echo" || s.type.key==="echo_hourly"){
      showToast("âœ¨æ¢ç´¢æç¤ºï¼šä½ æ’ˆåˆ°äº†ä¸€æ®µä¸ç©©å®šçš„å›è²ã€‚");
      bubbleDingCombo(combo);
    }else{
      bubblePopCombo(combo, 520 + Math.random()*90);
    }

    if(net.durability<=0){ breakNet(); return; }
    setDurUI();
  }

  function catchFish(nowDate){
    if(!fish) return;
    fish.alive=false;
    fish=null;

    const add = Math.round(5 * scoreMult(nowDate));
    score += add;

    uiScore.textContent=score;
    uiTitle.textContent=displayTitle(score);

    combo += 2;
    maxCombo = Math.max(maxCombo, combo);
    uiCombo.textContent=combo;

    fishHits += 1;
    uiFishCount.textContent=fishHits;

    net.durability -= rand(14, 22);
    spawnPop(net.x, net.y-10, `+${add}`);

    showToast(isFishNight(nowDate) ? "ğŸŒ™æ’ˆåˆ°å¤œé‡‘é­šï¼é¹¿é¹¿ï¼šä»Šæ™šå¾ˆæ—ºã€‚" : "ğŸ‰æ’ˆåˆ°é‡‘é­šï¼é¹¿é¹¿ï¼šé‹æ°£ä¸éŒ¯ã€‚");
    bubbleDingCombo(combo);

    if(net.durability<=0){ breakNet(); return; }
    setDurUI();
  }

  function breakNet(){
    net.durability=0;
    setDurUI();
    net.broken=true;
    net.down=false;
    net.cooldown=1.2;

    breaks += 1;
    uiBreaks.textContent=breaks;

    combo=0;
    uiCombo.textContent=combo;

    showToast("é¹¿é¹¿ï¼šç¶²å­ç ´äº†â€¦åˆ¥ç¡¬æ’å•¦ã€‚");
    bubbleThud();
  }

  // ===== Input =====
  function setPointerFromClient(clientX, clientY){
    const rect = canvas.getBoundingClientRect();
    pointer.x = (clientX - rect.left) * (W / rect.width);
    pointer.y = (clientY - rect.top)  * (H / rect.height);
  }
  canvas.addEventListener('mousemove', (e)=> setPointerFromClient(e.clientX, e.clientY));
  canvas.addEventListener('mousedown', (e)=>{
    setPointerFromClient(e.clientX,e.clientY);
    pointer.pressed=true;
    ensureAudio();
  });
  window.addEventListener('mouseup', ()=> pointer.pressed=false);

  canvas.addEventListener('touchstart', (e)=>{
    e.preventDefault();
    const t = e.touches[0];
    setPointerFromClient(t.clientX, t.clientY);
    pointer.pressed=true;
    ensureAudio();
  }, {passive:false});
  canvas.addEventListener('touchmove', (e)=>{
    e.preventDefault();
    const t = e.touches[0];
    setPointerFromClient(t.clientX, t.clientY);
  }, {passive:false});
  canvas.addEventListener('touchend', ()=> pointer.pressed=false);

  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==="r"){
      if(running){ resetGame(); bubblePopCombo(0, 620); }
    }
  });

  // ===== Buttons =====
  function startGameFromOverlay(){
    if (isPortrait()) {
      updateOrientationUI();
      showToast("ğŸ¦’ é¹¿é¹¿ï¼šå…ˆæ©«å‘ï¼è£‚ç¸«æ–¹å‘æœƒæ‰­æ›²è¦–ç•Œã€‚");
      return;
    }
    try { localStorage.setItem(LS_TUTORIAL_SEEN, "1"); } catch(_) {}
    overlay.style.display="none";
    resetGame();
    bubblePopCombo(0, 680);
    tryLockLandscape();
  }

  startBtn.addEventListener('click', startGameFromOverlay);
  quickStart.addEventListener('click', startGameFromOverlay);

  muteBtn.addEventListener('click', ()=>{
    audioOn = !audioOn;
    if(!audioOn){
      stopNightBgm();
      stopFreeBgm();
    }else if(running){
      startFreeBgm();
    }
    muteBtn.textContent = `éŸ³æ•ˆï¼š${audioOn ? "é–‹" : "é—œ"}`;
    bubblePopCombo(0, 460);
  });

  resetRankBtn.addEventListener('click', ()=>{
    saveRank([]);
    renderRank();
    bubblePopCombo(0, 420);
  });

  // ===== Spawn pacing =====
  let spawnTimer = 0;
  let fishTimer = 0;

  // ===== Main Loop =====
  let last = performance.now();
  function tick(now){
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;

    stepSfxCooldown(dt);

    if(toastTimer>0){
      toastTimer -= dt;
      if(toastTimer<=0) toast.classList.remove("show");
    }

    const nowDate = new Date();
    updateModeUI(nowDate);

    // ğŸŒ™ å¤œé–“é€²å‡ºï¼ˆä¿ç•™åŸå¤œé–“æç¤ºï¼‹å¤œéˆ´ï¼‹å¤œé–“æ¥µè¼•ç’°å¢ƒéŸ³ï¼‰
    const nowFish = isFishNight(nowDate);
    if(nowFish){
      document.body.classList.add("fish-night");
      if(!lastFishNight){
        nightBell();
        startNightBgm();
        showToast("ğŸŒ™ é¹¿é¹¿ä½è²èªªï¼šå¤œé–“ç³»çµ±å·²æ¥ç®¡ã€‚");
      }
      lastFishNight = true;
    }else{
      document.body.classList.remove("fish-night");
      if(lastFishNight) stopNightBgm();
      lastFishNight = false;
    }

    if(running){
      timeLeft -= dt;
      if(timeLeft <= 0){
        timeLeft = 0;
        uiTime.textContent = "0";
        endGame();
      }else{
        uiTime.textContent = String(Math.ceil(timeLeft));
      }

      // æ•´é»è§¸ç™¼
      if (nowDate.getMinutes() === 0) {
        const stamp = hourlyStamp(nowDate);
        if (stamp !== lastHourlyStamp) {
          lastHourlyStamp = stamp;
          triggerHourlyEvent();
        }
      }
      if(echoBoostTimer>0) echoBoostTimer -= dt;

      // net follow
      const follow = 12;
      net.x += (pointer.x - net.x) * (1 - Math.exp(-follow*dt));
      net.y += (pointer.y - net.y) * (1 - Math.exp(-follow*dt));
      net.x = clamp(net.x, 60, W-60);
      net.y = clamp(net.y, 110, H-60);

      if(!net.broken && net.cooldown<=0) net.down = pointer.pressed;
      if(net.cooldown>0) net.cooldown -= dt;

      // spawn shardsï¼ˆæš´èµ°ï¼šå¯†åº¦â†‘ï¼›é€Ÿåº¦ä¸è®Šï¼‰
      spawnTimer += dt;
      const frenzy = isFrenzy(nowDate);
      const spawnEvery = frenzy ? 0.42 : 0.60;
      const targetAlive = frenzy ? 14 : 10;

      if(spawnTimer >= spawnEvery){
        spawnTimer = 0;
        const alive = shards.filter(s=>s.alive).length;
        if(alive < targetAlive) shards.push(makeShard());
      }

      // fish spawnï¼ˆå¤œé–“æ›´å¤šï¼‰
      fishTimer += dt;
      if(fishTimer >= 2){
        fishTimer = 0;
        if(!fish){
          let p = 0.08;
          if(nowFish) p = 0.22;
          if(frenzy) p *= 1.10;
          if(Math.random() < p){
            fish = makeFish();
            showToast(nowFish ? "ğŸŒ™é‡‘é­šä¹‹å¤œï¼šé‡‘è‰²æ¸¸å½±å‡ºæ²’ï¼" : "âœ¨é‡‘é­šé©šå–œå‡ºç¾ï¼");
            bubblePopCombo(Math.min(combo, 10), 760);
          }
        }
      }

      // update shards
      for(const s of shards){
        if(!s.alive) continue;
        s.tw += dt*5;

        s.vx += Math.sin(s.tw)*10*dt;
        s.vy += Math.cos(s.tw*0.9)*7*dt;

        const sp = Math.hypot(s.vx,s.vy);
        const maxSp = 78;
        if(sp > maxSp){ s.vx *= maxSp/sp; s.vy *= maxSp/sp; }

        s.x += s.vx*dt;
        s.y += s.vy*dt;

        if(s.x < 70)    s.vx += 85*dt;
        if(s.x > W-70)  s.vx -= 85*dt;
        if(s.y < 120)   s.vy += 65*dt;
        if(s.y > H-70)  s.vy -= 65*dt;

        s.x = clamp(s.x, 60, W-60);
        s.y = clamp(s.y, 110, H-60);

        // å¾®èº²ï¼ˆæ›´å¥½ç„æº–ï¼‰
        if(net.down && !net.broken){
          const d2 = dist2(net.x, net.y, s.x, s.y);
          const fearR = 140;
          if(d2 < fearR*fearR){
            const d = Math.sqrt(d2) + 0.001;
            const ax = (s.x - net.x)/d;
            const ay = (s.y - net.y)/d;
            s.vx += ax * 65 * dt;
            s.vy += ay * 48 * dt;
          }
        }

        // catch
        if(net.down && !net.broken){
          const hit = dist2(net.x, net.y, s.x, s.y) < (net.r + s.r - 6) ** 2;
          if(hit) catchShard(s, nowDate);
        }
      }

      // update fish
      if(fish && fish.alive){
        fish.wiggle += dt*6;
        fish.vx += Math.sin(fish.wiggle)*10*dt;
        fish.vy += Math.cos(fish.wiggle*0.85)*8*dt;

        const sp = Math.hypot(fish.vx, fish.vy);
        const maxSp = 115;
        if(sp > maxSp){ fish.vx *= maxSp/sp; fish.vy *= maxSp/sp; }

        fish.x += fish.vx*dt;
        fish.y += fish.vy*dt;

        if(fish.x < 70)   fish.vx += 110*dt;
        if(fish.x > W-70) fish.vx -= 110*dt;
        if(fish.y < 130)  fish.vy += 85*dt;
        if(fish.y > H-70) fish.vy -= 65*dt;

        fish.x = clamp(fish.x, 60, W-60);
        fish.y = clamp(fish.y, 120, H-60);

        if(net.down && !net.broken){
          const hit = dist2(net.x, net.y, fish.x, fish.y) < (net.r + fish.r - 4) ** 2;
          if(hit) catchFish(nowDate);
        }
      }

      // pops
      for(let i=pops.length-1;i>=0;i--){
        const p = pops[i];
        p.t -= dt;
        p.y += p.vy*dt;
        p.vy -= 10*dt;
        if(p.t<=0) pops.splice(i,1);
      }

      // ç¶²ç ´ä¿®å¾©
      if(net.broken && net.cooldown <= 0){
        net.broken=false;
        net.durability=maxDurability;
        setDurUI();
        showToast("é¹¿é¹¿ï¼šæ›æ–°ç¶²äº†ï¼Œç¹¼çºŒæ’ˆã€‚");
        bubblePopCombo(0, 560);
      }
    }

    draw();
    requestAnimationFrame(tick);
  }

  // ===== Draw =====
  function draw(){
    ctx.clearRect(0,0,W,H);
    const t = performance.now()/1000;

    ctx.globalAlpha = 0.20;
    for(let i=0;i<5;i++){
      ctx.beginPath();
      const y = 110 + i*26 + Math.sin(t*1.2 + i)*5;
      ctx.ellipse(W/2, y, W*0.46, 10, 0, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,.5)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    for(const s of shards){ if(s.alive) drawShard(s); }
    if(fish && fish.alive) drawFish(fish);

    for(const p of pops){
      ctx.save();
      ctx.globalAlpha = clamp(p.t/0.7, 0, 1);
      ctx.font = "18px ui-sans-serif, system-ui";
      ctx.fillStyle = p.night ? "rgba(255,215,120,.98)" : "rgba(255,255,255,.92)";
      ctx.strokeStyle = "rgba(10,18,32,.35)";
      ctx.lineWidth = 3;
      ctx.strokeText(p.text, p.x+2, p.y);
      ctx.fillText(p.text, p.x+2, p.y);
      ctx.restore();
    }

    drawNet();

    ctx.globalAlpha = 0.10;
    ctx.fillStyle = "rgba(0,0,0,.9)";
    ctx.fillRect(0,0,W,14);
    ctx.globalAlpha = 1;
  }

  function drawShard(s){
    const isNight = document.body.classList.contains("fish-night");

    ctx.save();
    ctx.translate(s.x, s.y);
    const a = performance.now()/700 + s.tw;
    ctx.rotate(a);

    if(isNight){
      ctx.globalAlpha = 0.25;
      ctx.beginPath();
      ctx.arc(0, 0, s.r * 3.2, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255,215,120,.65)";
      ctx.fill();
    }

    ctx.globalAlpha = s.hourly ? 0.78 : 0.55;
    ctx.beginPath();
    ctx.arc(0,0, s.r*(s.hourly?2.5:2.1), 0, Math.PI*2);
    ctx.fillStyle = s.type.glow;
    ctx.fill();

    ctx.globalAlpha = 0.97;
    ctx.beginPath();
    ctx.moveTo(0, -s.r);
    ctx.lineTo(s.r, 0);
    ctx.lineTo(0, s.r);
    ctx.lineTo(-s.r, 0);
    ctx.closePath();
    ctx.fillStyle = s.type.color;
    ctx.fill();

    if(s.hourly){
      ctx.globalAlpha = 0.85;
      ctx.beginPath();
      ctx.arc(0,0, s.r*1.35, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,.85)";
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    ctx.restore();
  }

  function drawFish(f){
    ctx.save();
    ctx.translate(f.x, f.y);
    const ang = Math.atan2(f.vy, f.vx);
    ctx.rotate(ang);

    ctx.globalAlpha = 0.35;
    ctx.beginPath();
    ctx.arc(0,0, f.r*2.2, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.fill();

    ctx.globalAlpha = 0.95;
    ctx.beginPath();
    ctx.ellipse(0, 0, f.r*1.35, f.r*0.9, 0, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,170,90,.98)";
    ctx.fill();

    ctx.beginPath();
    ctx.arc(f.r*0.75, -f.r*0.15, 3.5, 0, Math.PI*2);
    ctx.fillStyle = "rgba(20,20,20,.9)";
    ctx.fill();

    ctx.restore();
  }

  function drawNet(){
    ctx.save();
    ctx.translate(net.x, net.y);
    const r = net.r + (net.down ? 6 : 0);

    if(net.down){
      ctx.globalAlpha = 0.14;
      ctx.beginPath();
      ctx.ellipse(8, 10, r*1.15, r*0.55, 0.2, 0, Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.9)";
      ctx.fill();
    }

    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.arc(0,0, r, 0, Math.PI*2);
    ctx.strokeStyle = net.broken ? "rgba(255,120,120,.92)" : "rgba(255,255,255,.92)";
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.globalAlpha = net.down ? 0.58 : 0.38;
    const lines = 7;
    for(let i=0;i<lines;i++){
      const a = (i/lines)*Math.PI;
      ctx.beginPath();
      ctx.moveTo(Math.cos(a)*r, Math.sin(a)*r);
      ctx.lineTo(Math.cos(a+Math.PI)*r, Math.sin(a+Math.PI)*r);
      ctx.strokeStyle = "rgba(255,255,255,.86)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    ctx.restore();
  }

  // ===== åˆå§‹é¡¯ç¤º =====
  renderRank();

  let seen = false;
  try { seen = localStorage.getItem(LS_TUTORIAL_SEEN) === "1"; } catch(_) {}

  if (seen) {
    overlay.style.display = "none";
    quickStart.style.display = "block";
    panel.classList.remove("tutorial-shrink");
    showToast("âš¡ é»å³ä¸‹è§’ã€Œå¿«é€Ÿé–‹å§‹ã€å³å¯é–‹å±€");
  } else {
    overlay.style.display = "grid";
    quickStart.style.display = "none";
    panel.classList.add("tutorial-shrink");
  }

  // ===== ä¸»è¿´åœˆ =====
  requestAnimationFrame(tick);

})();
</script>
</body>
</html>
