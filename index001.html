<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ²³å…§å¡”ï½œLINE å°éŠæˆ²</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg1:#eef7ff;
      --bg2:#ffffff;
      --card:#ffffffcc;
      --text:#0b1220;
      --muted:#5b6573;
      --accent:#2b7fff;
      --danger:#ff3b30;
      --ok:#14b86a;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif; color:var(--text); }
    body{
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      overflow:hidden;
    }
    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      gap:12px;
      max-width:860px;
      margin:0 auto;
    }
    .topbar{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width: 180px;
    }
    .title h1{
      margin:0; font-size:16px; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      font-size:12px;
      padding:2px 8px;
      border-radius: 999px;
      background: rgba(43,127,255,.12);
      color: var(--accent);
      border: 1px solid rgba(43,127,255,.25);
    }
    .sub{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 260px;
    }
    .stats{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius: 999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip strong{ color:var(--text); font-weight:700; }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:0;
      border-radius: 999px;
      padding:10px 12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background: var(--accent);
      color:#fff;
      border:1px solid rgba(0,0,0,.0);
    }
    .btn.danger{
      background: rgba(255,59,48,.10);
      border:1px solid rgba(255,59,48,.25);
      color: var(--danger);
    }
    .btn:active{ transform: translateY(1px); }
    .main{
      flex:1;
      display:flex;
      gap:12px;
      min-height: 0;
    }
    .board{
      flex: 1;
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      position:relative;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .boardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.4;
    }
    .hint b{ color: var(--text); }
    .selectInfo{
      font-size:12px;
      color: var(--muted);
      text-align:right;
      white-space:nowrap;
    }

    .poles{
      flex:1;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      align-items:stretch;
      min-height: 0;
    }
    .pole{
      position:relative;
      border-radius: 16px;
      background: rgba(255,255,255,.65);
      border:1px dashed rgba(0,0,0,.12);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:10px 10px 14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pole:hover{ border-color: rgba(43,127,255,.35); }
    .poleTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between;
      pointer-events:none;
    }
    .poleLabel{
      font-size:12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .poleLabel .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(43,127,255,.35);
    }
    .poleCount{
      font-size:12px;
      color: var(--muted);
    }
    .rod{
      position:absolute;
      left:50%;
      bottom:16px;
      width:10px;
      height: calc(100% - 52px);
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(30,41,59,.25), rgba(30,41,59,.08));
      border-radius: 999px;
      pointer-events:none;
    }
    .base{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      height:10px;
      border-radius:999px;
      background: rgba(30,41,59,.12);
      pointer-events:none;
    }

    .stack{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-bottom:8px;
      min-height: 0;
    }
    .disk{
      height: 26px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color: rgba(0,0,0,.75);
      user-select:none;
      touch-action: manipulation;
    }
    .disk.small{ height:24px; }
    .disk.selected{
      outline: 2px solid rgba(43,127,255,.65);
      transform: translateY(-3px);
      box-shadow: 0 14px 24px rgba(43,127,255,.18);
    }

    .side{
      width: 300px;
      max-width: 44vw;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 0;
    }
    .card{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      min-height: 0;
    }
    .card h2{
      margin:0 0 8px;
      font-size:14px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      color: var(--muted);
    }
    .row:last-child{ border-bottom:0; }
    .row b{ color: var(--text); }
    .select{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    select{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:13px;
    }
    .toast{
      position: fixed;
      left:50%;
      bottom: calc(14px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      z-index: 20;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(520px, 92%);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      padding:16px;
      border:1px solid rgba(0,0,0,.08);
    }
    .modal h3{ margin:0 0 8px; font-size:16px; }
    .modal p{ margin:0 0 12px; color: var(--muted); font-size:13px; line-height:1.5; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin:10px 0 12px;
    }
    .kpi .box{
      background: rgba(43,127,255,.08);
      border:1px solid rgba(43,127,255,.18);
      border-radius: 16px;
      padding:10px;
      text-align:center;
    }
    .kpi .box .v{
      font-size:16px;
      font-weight:800;
      color: var(--text);
    }
    .kpi .box .t{
      font-size:12px;
      color: var(--muted);
      margin-top:2px;
    }

    @media (max-width: 820px){
      .main{ flex-direction:column; }
      .side{ width:100%; max-width:100%; flex-direction:row; }
      .side .card{ flex:1; }
    }
    @media (max-width: 520px){
      .side{ flex-direction:column; }
      .sub{ max-width: 220px; }
      .disk{ height:24px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>æ²³å…§å¡” <span class="badge" id="modeBadge">LIFF</span></h1>
        <div class="sub" id="userLine">è¼‰å…¥ä¸­â€¦</div>
      </div>

      <div class="stats">
        <div class="chip">æ­¥æ•¸ <strong id="moves">0</strong></div>
        <div class="chip">æ™‚é–“ <strong id="time">00:00</strong></div>
        <div class="controls">
          <button class="btn" id="btnHow">ç©æ³•</button>
          <button class="btn" id="btnSound">éŸ³æ•ˆï¼šé–‹</button>
          <button class="btn danger" id="btnRestart">é‡ä¾†</button>
          <button class="btn primary" id="btnClose">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="board">
        <div class="boardHeader">
          <div class="hint">
            é»ä¸€ä¸‹ç›¤å­ã€Œæ‹¿èµ·ã€â†’ å†é»æŸ±å­ã€Œæ”¾ä¸‹ã€ã€‚
            <br/>è¦å‰‡ï¼š<b>å°ç›¤æ‰èƒ½æ”¾åœ¨å¤§ç›¤ä¸Š</b>ã€‚
          </div>
          <div class="selectInfo" id="selectInfo">æœªé¸å–</div>
        </div>

        <div class="poles" id="poles">
          <!-- poles injected -->
        </div>

        <div class="overlay" id="overlayWin">
          <div class="modal">
            <h3>ğŸ‰ é€šé—œæˆåŠŸï¼</h3>
            <p id="winText">ä½ å®Œæˆäº†æŒ‘æˆ°ã€‚</p>
            <div class="kpi">
              <div class="box">
                <div class="v" id="kpiMoves">0</div>
                <div class="t">æ­¥æ•¸</div>
              </div>
              <div class="box">
                <div class="v" id="kpiTime">00:00</div>
                <div class="t">æ™‚é–“</div>
              </div>
              <div class="box">
                <div class="v" id="kpiBest">â€”</div>
                <div class="t">æœ€ä½³</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="btnShare">åˆ†äº«</button>
              <button class="btn primary" id="btnNext">ä¸‹ä¸€é—œ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <h2>é—œå¡</h2>
          <div class="row">
            <span>ç›¤å­æ•¸</span>
            <span class="select">
              <select id="level">
                <option value="3">3ï¼ˆæ–°æ‰‹ï¼‰</option>
                <option value="4">4</option>
                <option value="5" selected>5ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8ï¼ˆå›°é›£ï¼‰</option>
              </select>
              <button class="btn" id="btnNew">é–‹å§‹</button>
            </span>
          </div>
          <div class="row">
            <span>ç†è«–æœ€å°‘æ­¥æ•¸</span>
            <span><b id="minMoves">â€”</b></span>
          </div>
          <div class="row">
            <span>æœ€ä½³ç´€éŒ„ï¼ˆæ­¤ç›¤æ•¸ï¼‰</span>
            <span><b id="best">â€”</b></span>
          </div>
        </div>

        <div class="card">
          <h2>å°æç¤º</h2>
          <div class="row"><span>å¿«é€Ÿæ“ä½œ</span><span><b>ç›¤å­â†’æŸ±å­</b></span></div>
          <div class="row"><span>æ’¤éŠ·</span><span><b>æš«ä¸æä¾›</b></span></div>
          <div class="row"><span>ç›®æ¨™</span><span><b>å…¨éƒ¨ç§»åˆ°ç¬¬ 3 æŸ±</b></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** ==========================
 *  æ²³å…§å¡”ï¼ˆLIFF ç‰ˆï¼‰å–®æª”éŠæˆ²
 *  - é»ç›¤å­æ‹¿èµ· -> é»æŸ±å­æ”¾ä¸‹
 *  - localStorage è¨˜éŒ„æœ€ä½³ï¼šåŒç›¤æ•¸æœ€å°‘æ­¥/æœ€çŸ­æ™‚
 *  - æ”¯æ´ LIFF initï¼Œç¾¤çµ„å…§é»é–‹
 * ========================== */

const LS_BEST_PREFIX = "hanoi_best_"; // hanoi_best_5 => {bestMoves,bestTimeSec}

const ui = {
  userLine: document.getElementById("userLine"),
  modeBadge: document.getElementById("modeBadge"),
  poles: document.getElementById("poles"),
  moves: document.getElementById("moves"),
  time: document.getElementById("time"),
  selectInfo: document.getElementById("selectInfo"),
  level: document.getElementById("level"),
  minMoves: document.getElementById("minMoves"),
  best: document.getElementById("best"),
  toast: document.getElementById("toast"),
  overlayWin: document.getElementById("overlayWin"),
  winText: document.getElementById("winText"),
  kpiMoves: document.getElementById("kpiMoves"),
  kpiTime: document.getElementById("kpiTime"),
  kpiBest: document.getElementById("kpiBest"),
  btnHow: document.getElementById("btnHow"),
  btnSound: document.getElementById("btnSound"),
  btnRestart: document.getElementById("btnRestart"),
  btnClose: document.getElementById("btnClose"),
  btnNew: document.getElementById("btnNew"),
  btnShare: document.getElementById("btnShare"),
  btnNext: document.getElementById("btnNext"),
};

let N = parseInt(ui.level.value, 10);
let stacks = [[], [], []]; // each is array of disk sizes (small=1 ... big=N). top is last.
let selected = null; // {fromPole, size}
let moves = 0;

let timer = null;
let startAt = null; // Date.now()
let elapsedSec = 0;

let soundOn = true;
let audioCtx = null;

function fmtTime(sec){
  sec = Math.max(0, sec|0);
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1100);
}

function minMovesFor(n){
  // 2^n - 1
  return (2 ** n) - 1;
}

function getBest(n){
  try{
    const raw = localStorage.getItem(LS_BEST_PREFIX + n);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(typeof obj !== "object" || obj === null) return null;
    return {
      bestMoves: Number(obj.bestMoves),
      bestTimeSec: Number(obj.bestTimeSec),
    };
  }catch{ return null; }
}

function setBest(n, bestMoves, bestTimeSec){
  const obj = { bestMoves, bestTimeSec };
  localStorage.setItem(LS_BEST_PREFIX + n, JSON.stringify(obj));
}

function renderBest(){
  ui.minMoves.textContent = String(minMovesFor(N));
  const b = getBest(N);
  if(!b || !isFinite(b.bestMoves) || !isFinite(b.bestTimeSec)){
    ui.best.textContent = "â€”";
    return;
  }
  ui.best.textContent = `${b.bestMoves} æ­¥ / ${fmtTime(b.bestTimeSec)}`;
}

function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function beep(type){
  if(!soundOn) return;
  try{
    ensureAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    const base = 420;
    const freq = type === "pick" ? base + 80 : (type === "drop" ? base - 40 : base);
    o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.12, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t);
    o.stop(t + 0.13);
  }catch{}
}

function startTimer(){
  stopTimer();
  startAt = Date.now() - elapsedSec*1000;
  timer = setInterval(()=>{
    elapsedSec = Math.floor((Date.now() - startAt)/1000);
    ui.time.textContent = fmtTime(elapsedSec);
  }, 250);
}
function stopTimer(){
  if(timer){ clearInterval(timer); timer=null; }
}

function resetGame(n){
  N = n;
  stacks = [[], [], []];
  for(let s=n; s>=1; s--) stacks[0].push(s); // bottom big -> top small (top is last)
  selected = null;
  moves = 0;
  elapsedSec = 0;
  ui.moves.textContent = "0";
  ui.time.textContent = "00:00";
  ui.selectInfo.textContent = "æœªé¸å–";
  ui.overlayWin.classList.remove("show");
  renderBest();
  render();
  startTimer();
  toast(`é–‹å§‹ï¼š${N} ç›¤`);
}

function diskWidthPercent(size){
  // smallest ~35%, largest ~95%
  const min = 35;
  const max = 95;
  const t = (size-1)/(N-1 || 1);
  return min + (max-min)*t;
}

function diskBg(size){
  // simple pastel-ish gradient by size (no hardcoding a palette array)
  const hue = 200 + (size-1) * (120/(Math.max(1,N-1)));
  return `linear-gradient(135deg, hsla(${hue}, 90%, 68%, .95), hsla(${hue+18}, 90%, 78%, .95))`;
}

function render(){
  ui.poles.innerHTML = "";
  for(let i=0;i<3;i++){
    const pole = document.createElement("div");
    pole.className = "pole";
    pole.dataset.pole = String(i);

    const poleTop = document.createElement("div");
    poleTop.className = "poleTop";
    poleTop.innerHTML = `
      <div class="poleLabel"><span class="dot"></span>ç¬¬ ${i+1} æŸ±</div>
      <div class="poleCount">${stacks[i].length} å€‹</div>
    `;

    const rod = document.createElement("div");
    rod.className = "rod";
    const base = document.createElement("div");
    base.className = "base";

    const stack = document.createElement("div");
    stack.className = "stack";

    // render bottom->top visually: we already have bottom first in array, top last
    for(const size of stacks[i]){
      const d = document.createElement("div");
      d.className = "disk" + (size<=2 ? " small": "");
      d.style.width = diskWidthPercent(size) + "%";
      d.style.background = diskBg(size);
      d.dataset.size = String(size);
      d.dataset.pole = String(i);
      d.textContent = size; // å¯æ”¹æˆä¸é¡¯ç¤ºæ•¸å­—

      // only top disk clickable (but allow selecting by tapping top disk area anyway)
      // We'll handle selection by pole tap: pick top. For better feedback, also allow disk tap.
      d.addEventListener("click",(e)=>{
        e.stopPropagation();
        onPoleTap(i);
      });

      // selected highlight if it is the selected disk
      if(selected && selected.fromPole === i && selected.size === size && size === stacks[i][stacks[i].length-1]){
        d.classList.add("selected");
      }
      stack.appendChild(d);
    }

    pole.appendChild(poleTop);
    pole.appendChild(rod);
    pole.appendChild(base);
    pole.appendChild(stack);

    pole.addEventListener("click", ()=> onPoleTap(i));
    ui.poles.appendChild(pole);
  }
}

function topDisk(poleIndex){
  const arr = stacks[poleIndex];
  return arr.length ? arr[arr.length-1] : null;
}

function canPlace(size, poleIndex){
  const top = topDisk(poleIndex);
  if(top === null) return true;
  return size < top;
}

function onPoleTap(poleIndex){
  // if no selection -> pick from this pole
  if(!selected){
    const size = topDisk(poleIndex);
    if(size === null){
      toast("é€™æ ¹æŸ±å­æ²’æœ‰ç›¤å­");
      return;
    }
    selected = { fromPole: poleIndex, size };
    ui.selectInfo.textContent = `å·²æ‹¿èµ·ï¼š${size}ï¼ˆå¾ç¬¬ ${poleIndex+1} æŸ±ï¼‰`;
    beep("pick");
    render();
    return;
  }

  // if selected exists -> try to place to this pole
  const { fromPole, size } = selected;

  // tapping same pole cancels
  if(poleIndex === fromPole){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  if(!canPlace(size, poleIndex)){
    toast("ä¸èƒ½æŠŠå¤§ç›¤æ”¾åœ¨å°ç›¤ä¸Š");
    beep("bad");
    return;
  }

  // execute move
  const fromArr = stacks[fromPole];
  const actual = fromArr[fromArr.length-1];
  if(actual !== size){
    // safety
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }
  fromArr.pop();
  stacks[poleIndex].push(size);

  moves += 1;
  ui.moves.textContent = String(moves);
  selected = null;
  ui.selectInfo.textContent = "æœªé¸å–";
  beep("drop");
  render();

  checkWin();
}

function checkWin(){
  if(stacks[2].length !== N) return;

  stopTimer();
  ui.overlayWin.classList.add("show");

  const theoretical = minMovesFor(N);
  const ratio = moves === theoretical ? "å®Œç¾ï¼" : (moves < theoretical + 10 ? "å¾ˆæ¥è¿‘æœ€ä½³ï¼" : "é€šé—œæˆåŠŸï¼");
  ui.winText.textContent = `ä½ ç”¨ ${moves} æ­¥ã€${fmtTime(elapsedSec)} å®Œæˆ ${N} ç›¤ã€‚${ratio}ï¼ˆæœ€å°‘æ­¥æ•¸ï¼š${theoretical}ï¼‰`;

  ui.kpiMoves.textContent = String(moves);
  ui.kpiTime.textContent = fmtTime(elapsedSec);

  // update best
  const b = getBest(N);
  let isNew = false;
  if(!b || !isFinite(b.bestMoves) || !isFinite(b.bestTimeSec)){
    setBest(N, moves, elapsedSec);
    isNew = true;
  }else{
    // prioritize fewer moves; tie -> faster time
    const better = (moves < b.bestMoves) || (moves === b.bestMoves && elapsedSec < b.bestTimeSec);
    if(better){
      setBest(N, moves, elapsedSec);
      isNew = true;
    }
  }
  const nb = getBest(N);
  ui.kpiBest.textContent = nb ? `${nb.bestMoves} / ${fmtTime(nb.bestTimeSec)}` : "â€”";
  renderBest();

  if(isNew) toast("ğŸ† æ–°æœ€ä½³ç´€éŒ„ï¼");
}

function showHow(){
  const msg = [
    "ç©æ³•ï¼š",
    "1) é»ä¸€ä¸‹ã€Œä¾†æºæŸ±ã€æ‹¿èµ·æœ€ä¸Šå±¤ç›¤å­",
    "2) å†é»ã€Œç›®æ¨™æŸ±ã€æ”¾ä¸‹",
    "è¦å‰‡ï¼šå°ç›¤æ‰èƒ½æ”¾åœ¨å¤§ç›¤ä¸Š",
    `ç›®æ¨™ï¼šæŠŠå…¨éƒ¨ ${N} å€‹ç›¤å­ç§»åˆ°ç¬¬ 3 æŸ±`,
  ].join("\n");
  alert(msg);
}

async function initLIFF(){
  // ä½ éƒ¨ç½²å¾Œï¼Œè«‹æŠŠé€™è£¡æ”¹æˆä½ çš„ LIFF ID
  const LIFF_ID = "PUT_YOUR_LIFF_ID_HERE";

  const inLine = /Line/i.test(navigator.userAgent) || (window.liff && liff.isInClient && liff.isInClient());

  try{
    if(window.liff && LIFF_ID && LIFF_ID !== "PUT_YOUR_LIFF_ID_HERE"){
      await liff.init({ liffId: LIFF_ID });
      ui.modeBadge.textContent = liff.isInClient() ? "LINE" : "WEB";
      if(liff.isLoggedIn()){
        const p = await liff.getProfile();
        ui.userLine.textContent = `Hiï¼Œ${p.displayName} ğŸ‘‹ï¼ˆé»é–‹å³ç©ï¼‰`;
      }else{
        ui.userLine.textContent = "å°šæœªç™»å…¥ï¼ˆå¯ç›´æ¥ç©ï¼‰";
      }
    }else{
      ui.modeBadge.textContent = inLine ? "LINE" : "WEB";
      ui.userLine.textContent = inLine ? "åœ¨ LINE å…§é–‹å•Ÿ âœ…" : "ä¸€èˆ¬ç€è¦½å™¨æ¨¡å¼";
    }
  }catch(err){
    ui.modeBadge.textContent = "WEB";
    ui.userLine.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œä½†ä»å¯éŠç©";
  }
}

function closeWindow(){
  if(window.liff && liff.isInClient && liff.isInClient()){
    liff.closeWindow();
  }else{
    toast("é LINE å…§ï¼Œç„¡æ³•è‡ªå‹•é—œé–‰");
  }
}

async function shareResult(){
  const text = `æˆ‘å‰›å‰›åœ¨æ²³å…§å¡”ï¼ˆ${N} ç›¤ï¼‰ç”¨ ${moves} æ­¥ã€${fmtTime(elapsedSec)} é€šé—œï¼`;
  try{
    if(window.liff && liff.isApiAvailable && liff.isApiAvailable("shareTargetPicker")){
      await liff.shareTargetPicker([{ type:"text", text }]);
      toast("å·²å‘¼å«åˆ†äº«");
    }else{
      await navigator.clipboard.writeText(text);
      toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
    }
  }catch{
    try{
      prompt("è¤‡è£½åˆ†äº«æ–‡å­—ï¼š", text);
    }catch{}
  }
}

/** Events */
ui.btnHow.addEventListener("click", showHow);

ui.btnSound.addEventListener("click", ()=>{
  soundOn = !soundOn;
  ui.btnSound.textContent = `éŸ³æ•ˆï¼š${soundOn ? "é–‹" : "é—œ"}`;
  if(soundOn) beep("pick");
});

ui.btnRestart.addEventListener("click", ()=>{
  resetGame(N);
});

ui.btnClose.addEventListener("click", closeWindow);

ui.btnNew.addEventListener("click", ()=>{
  const n = parseInt(ui.level.value, 10);
  resetGame(n);
});

ui.btnNext.addEventListener("click", ()=>{
  ui.overlayWin.classList.remove("show");
  const next = Math.min(8, N + 1);
  ui.level.value = String(next);
  resetGame(next);
});

ui.btnShare.addEventListener("click", shareResult);

/** Start */
(async function main(){
  await initLIFF();
  renderBest();
  resetGame(N);
})();
</script>
</body>
</html>
