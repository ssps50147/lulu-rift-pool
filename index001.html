<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é¹¿é¹¿æ¬é‹ä»»å‹™ï½œé¹¿ç²‰æ²³å…§å¡”</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg1:#fff1f7;
      --bg2:#f3fbff;
      --card:#ffffffcc;
      --text:#12202c;
      --muted:#5b6b7a;

      --pink:#ff5fa2;
      --blue:#2b7fff;
      --mint:#14b86a;
      --gold:#ffb020;

      --shadow: 0 12px 34px rgba(0,0,0,.12);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif; color:var(--text); }
    body{
      background: radial-gradient(1200px 600px at 20% 0%, var(--bg1), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, var(--bg2), transparent 55%),
                  linear-gradient(180deg, #fff, #f8fbff);
      overflow:hidden;
    }
    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      gap:12px;
      max-width:920px;
      margin:0 auto;
    }

    .topbar{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }
    .logo{
      width:44px; height:44px;
      border-radius: 14px;
      background: #fff;
      border:1px solid rgba(0,0,0,.07);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width: 160px;
    }
    .title h1{
      margin:0; font-size:16px; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .badge{
      font-size:12px;
      padding:2px 8px;
      border-radius: 999px;
      background: rgba(43,127,255,.12);
      color: var(--blue);
      border: 1px solid rgba(43,127,255,.25);
    }
    .sub{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 320px;
    }

    .stats{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius: 999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip strong{ color:var(--text); font-weight:800; }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:0;
      border-radius: 999px;
      padding:10px 12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue), #6aa7ff);
      color:#fff;
      border:0;
    }
    .btn.danger{
      background: rgba(255,95,162,.10);
      border:1px solid rgba(255,95,162,.28);
      color: var(--pink);
    }
    .btn:active{ transform: translateY(1px); }

    .main{
      flex:1;
      display:flex;
      gap:12px;
      min-height: 0;
    }
    .board{
      flex: 1;
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      position:relative;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .boardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }
    .hint b{ color: var(--text); }
    .selectInfo{
      font-size:12px;
      color: var(--muted);
      text-align:right;
      white-space:nowrap;
    }

    .poles{
      flex:1;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      align-items:stretch;
      min-height: 0;
    }
    .pole{
      position:relative;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      border:1px dashed rgba(0,0,0,.12);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:10px 10px 14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pole:hover{ border-color: rgba(43,127,255,.35); }
    .poleTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between;
      pointer-events:none;
      gap:10px;
    }
    .poleLabel{
      font-size:12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
      max-width: 70%;
    }
    .poleLabel .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(255,95,162,.45);
    }
    .poleLabel span.name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .poleCount{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .rod{
      position:absolute;
      left:50%;
      bottom:16px;
      width:10px;
      height: calc(100% - 52px);
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(18,32,44,.22), rgba(18,32,44,.06));
      border-radius: 999px;
      pointer-events:none;
    }
    .base{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      height:10px;
      border-radius:999px;
      background: rgba(18,32,44,.10);
      pointer-events:none;
    }

    .stack{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-bottom:8px;
      min-height: 0;
    }

    /* é¹¿ç²‰å¾½ç« ï¼ˆç›¤å­ï¼‰ */
    .disk{
      height: 28px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 10px;
      user-select:none;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
    }
    .disk:before{
      content:"";
      position:absolute;
      inset:-30px -30px auto auto;
      width:80px; height:80px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 60%);
      transform: rotate(20deg);
      opacity:.7;
    }
    .disk.small{ height:26px; }
    .disk.selected{
      outline: 2px solid rgba(43,127,255,.65);
      transform: translateY(-3px);
      box-shadow: 0 14px 26px rgba(43,127,255,.18);
    }
    .disk .left{
      display:flex;
      align-items:center;
      gap:8px;
      z-index:1;
      min-width: 0;
    }
    .disk .pin{
      width:18px;height:18px;border-radius: 6px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.08);
      display:grid; place-items:center;
      font-size:12px;
    }
    .disk .txt{
      font-size:12px;
      color: rgba(0,0,0,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 180px;
    }
    .disk .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.42);
      border:1px solid rgba(0,0,0,.08);
      color: rgba(0,0,0,.70);
      z-index:1;
      white-space:nowrap;
    }

    .side{
      width: 320px;
      max-width: 46vw;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 0;
    }
    .card{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      min-height: 0;
    }
    .card h2{
      margin:0 0 8px;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:3px 8px;
      border-radius: 999px;
      background: rgba(255,176,32,.14);
      border:1px solid rgba(255,176,32,.28);
      color: #9a5a00;
      white-space:nowrap;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      color: var(--muted);
    }
    .row:last-child{ border-bottom:0; }
    .row b{ color: var(--text); }
    .select{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    select{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:13px;
    }

    .toast{
      position: fixed;
      left:50%;
      bottom: calc(14px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(18,32,44,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      z-index: 20;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(560px, 92%);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      padding:16px;
      border:1px solid rgba(0,0,0,.08);
    }
    .modal h3{ margin:0 0 8px; font-size:16px; }
    .modal p{ margin:0 0 12px; color: var(--muted); font-size:13px; line-height:1.55; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin:10px 0 12px;
    }
    .kpi .box{
      background: rgba(43,127,255,.08);
      border:1px solid rgba(43,127,255,.18);
      border-radius: 16px;
      padding:10px;
      text-align:center;
    }
    .kpi .box .v{
      font-size:16px;
      font-weight:900;
      color: var(--text);
    }
    .kpi .box .t{
      font-size:12px;
      color: var(--muted);
      margin-top:2px;
    }

    @media (max-width: 840px){
      .main{ flex-direction:column; }
      .side{ width:100%; max-width:100%; flex-direction:row; }
      .side .card{ flex:1; }
    }
    @media (max-width: 520px){
      .side{ flex-direction:column; }
      .sub{ max-width: 240px; }
      .disk{ height:26px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="é¹¿é¹¿">
          <!-- ç°¡å–® SVG é¹¿é¹¿é ­åƒ -->
          <svg width="44" height="44" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" role="img">
            <rect x="0" y="0" width="64" height="64" rx="16" fill="#FFF7FB"/>
            <path d="M22 44c0-10 8-18 18-18s18 8 18 18" stroke="#1A2B3A" stroke-width="3" stroke-linecap="round"/>
            <path d="M36 18c2-6 8-8 13-5" stroke="#FFB020" stroke-width="4" stroke-linecap="round"/>
            <path d="M33 18c-2-6-8-8-13-5" stroke="#FFB020" stroke-width="4" stroke-linecap="round"/>
            <circle cx="26" cy="34" r="3" fill="#1A2B3A"/>
            <circle cx="46" cy="34" r="3" fill="#1A2B3A"/>
            <path d="M30 42c4 3 10 3 14 0" stroke="#1A2B3A" stroke-width="3" stroke-linecap="round"/>
            <path d="M29 26c0-6 6-10 11-10" stroke="#FF5FA2" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>é¹¿é¹¿æ¬é‹ä»»å‹™ <span class="badge" id="modeBadge">LIFF</span></h1>
          <div class="sub" id="userLine">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </div>

      <div class="stats">
        <div class="chip">æ­¥æ•¸ <strong id="moves">0</strong></div>
        <div class="chip">æ™‚é–“ <strong id="time">00:00</strong></div>
        <div class="controls">
          <button class="btn" id="btnHow">ç©æ³•</button>
          <button class="btn" id="btnSound">éŸ³æ•ˆï¼šé–‹</button>
          <button class="btn danger" id="btnRestart">é‡ä¾†</button>
          <button class="btn primary" id="btnClose">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="board">
        <div class="boardHeader">
          <div class="hint">
            é¹¿ç²‰è«‹å¹«é¹¿é¹¿æŠŠã€Œç¢ç‰‡å¾½ç« ã€æ¬åˆ° <b>ç¬¬ 3 æŸ±ï¼ˆå¤©ç©ºè£‚ç¸«æŸ±ï¼‰</b>ï¼
            <br/>æ“ä½œï¼šé»ä¸€ä¸‹å¾½ç« ã€Œæ‹¿èµ·ã€â†’ å†é»æŸ±å­ã€Œæ”¾ä¸‹ã€ã€‚è¦å‰‡ï¼š<b>å°å¾½ç« æ‰èƒ½æ”¾åœ¨å¤§å¾½ç« ä¸Š</b>ã€‚
          </div>
          <div class="selectInfo" id="selectInfo">æœªé¸å–</div>
        </div>

        <div class="poles" id="poles"></div>

        <div class="overlay" id="overlayWin">
          <div class="modal">
            <h3>ğŸ‰ ä»»å‹™å®Œæˆï¼é¹¿é¹¿è¶…å®‰å¿ƒ</h3>
            <p id="winText">ä½ å®Œæˆäº†æ¬é‹ã€‚</p>
            <div class="kpi">
              <div class="box">
                <div class="v" id="kpiMoves">0</div>
                <div class="t">æ­¥æ•¸</div>
              </div>
              <div class="box">
                <div class="v" id="kpiTime">00:00</div>
                <div class="t">æ™‚é–“</div>
              </div>
              <div class="box">
                <div class="v" id="kpiBest">â€”</div>
                <div class="t">æœ€ä½³</div>
              </div>
            </div>
            <div class="actions">
              <button class="btn" id="btnShare">åˆ†äº«</button>
              <button class="btn primary" id="btnNext">ä¸‹ä¸€é—œ</button>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <h2>é—œå¡ <span class="pill">é¹¿ç²‰æŒ‘æˆ°</span></h2>
          <div class="row">
            <span>å¾½ç« æ•¸ï¼ˆç›¤å­ï¼‰</span>
            <span class="select">
              <select id="level">
                <option value="3">3ï¼ˆæš–èº«ï¼‰</option>
                <option value="4">4</option>
                <option value="5" selected>5ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8ï¼ˆè£‚ç¸«ç´šï¼‰</option>
              </select>
              <button class="btn" id="btnNew">é–‹å§‹</button>
            </span>
          </div>
          <div class="row">
            <span>ç†è«–æœ€å°‘æ­¥æ•¸</span>
            <span><b id="minMoves">â€”</b></span>
          </div>
          <div class="row">
            <span>æœ€ä½³ç´€éŒ„ï¼ˆæ­¤é—œï¼‰</span>
            <span><b id="best">â€”</b></span>
          </div>
        </div>

        <div class="card">
          <h2>ä»»å‹™æç¤º</h2>
          <div class="row"><span>ç›®æ¨™</span><span><b>å…¨éƒ¨ç§»åˆ°ç¬¬ 3 æŸ±</b></span></div>
          <div class="row"><span>æ“ä½œ</span><span><b>å¾½ç«  â†’ æŸ±å­</b></span></div>
          <div class="row"><span>è¦å‰‡</span><span><b>å°æ”¾å¤§ä¸Š</b></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** é¹¿é¹¿ Ã— é¹¿ç²‰ æ²³å…§å¡”ï¼ˆLIFFï¼‰ */
const LS_BEST_PREFIX = "lulu_hanoi_best_"; // lulu_hanoi_best_5 => {bestMoves,bestTimeSec}

const ui = {
  userLine: document.getElementById("userLine"),
  modeBadge: document.getElementById("modeBadge"),
  poles: document.getElementById("poles"),
  moves: document.getElementById("moves"),
  time: document.getElementById("time"),
  selectInfo: document.getElementById("selectInfo"),
  level: document.getElementById("level"),
  minMoves: document.getElementById("minMoves"),
  best: document.getElementById("best"),
  toast: document.getElementById("toast"),
  overlayWin: document.getElementById("overlayWin"),
  winText: document.getElementById("winText"),
  kpiMoves: document.getElementById("kpiMoves"),
  kpiTime: document.getElementById("kpiTime"),
  kpiBest: document.getElementById("kpiBest"),
  btnHow: document.getElementById("btnHow"),
  btnSound: document.getElementById("btnSound"),
  btnRestart: document.getElementById("btnRestart"),
  btnClose: document.getElementById("btnClose"),
  btnNew: document.getElementById("btnNew"),
  btnShare: document.getElementById("btnShare"),
  btnNext: document.getElementById("btnNext"),
};

const POLE_NAMES = ["æ¨¹å±‹æŸ±", "è£œçµ¦æŸ±", "å¤©ç©ºè£‚ç¸«æŸ±"];

let N = parseInt(ui.level.value, 10);
let stacks = [[], [], []]; // disk sizes (1 small .. N big). top is last.
let selected = null; // {fromPole, size}
let moves = 0;

let timer = null;
let startAt = null;
let elapsedSec = 0;

let soundOn = true;
let audioCtx = null;

function fmtTime(sec){
  sec = Math.max(0, sec|0);
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1100);
}

function minMovesFor(n){ return (2 ** n) - 1; }

function getBest(n){
  try{
    const raw = localStorage.getItem(LS_BEST_PREFIX + n);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj) return null;
    return { bestMoves: Number(obj.bestMoves), bestTimeSec: Number(obj.bestTimeSec) };
  }catch{ return null; }
}
function setBest(n, bestMoves, bestTimeSec){
  localStorage.setItem(LS_BEST_PREFIX + n, JSON.stringify({ bestMoves, bestTimeSec }));
}
function renderBest(){
  ui.minMoves.textContent = String(minMovesFor(N));
  const b = getBest(N);
  ui.best.textContent = (!b || !isFinite(b.bestMoves) || !isFinite(b.bestTimeSec))
    ? "â€”"
    : `${b.bestMoves} æ­¥ / ${fmtTime(b.bestTimeSec)}`;
}

function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function popSfx(kind){
  if(!soundOn) return;
  try{
    ensureAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    const f = kind==="pick" ? 520 : (kind==="drop" ? 420 : 320);
    o.frequency.setValueAtTime(f, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.10, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t + 0.13);
  }catch{}
}

function startTimer(){
  stopTimer();
  startAt = Date.now() - elapsedSec*1000;
  timer = setInterval(()=>{
    elapsedSec = Math.floor((Date.now() - startAt)/1000);
    ui.time.textContent = fmtTime(elapsedSec);
  }, 250);
}
function stopTimer(){
  if(timer){ clearInterval(timer); timer=null; }
}

function resetGame(n){
  N = n;
  stacks = [[], [], []];
  for(let s=n; s>=1; s--) stacks[0].push(s);
  selected = null;
  moves = 0;
  elapsedSec = 0;

  ui.moves.textContent = "0";
  ui.time.textContent = "00:00";
  ui.selectInfo.textContent = "æœªé¸å–";
  ui.overlayWin.classList.remove("show");

  renderBest();
  render();
  startTimer();
  toast(`é¹¿ç²‰é›†åˆï¼${N} æšç¢ç‰‡å¾½ç« é–‹æ¬`);
}

function diskWidthPercent(size){
  const min = 36, max = 96;
  const t = (size-1)/(N-1 || 1);
  return min + (max-min)*t;
}
function diskBg(size){
  // ç²‰â†’è—â†’é‡‘ çš„æŸ”å’Œæ¼¸å±¤ï¼ˆä¾å¤§å°è®Šè‰²ï¼‰
  const t = (size-1)/(N-1 || 1);
  const h = 330 + t*110; // 330(ç²‰ç´«) -> 80(é‡‘)
  return `linear-gradient(135deg,
    hsla(${h}, 95%, 70%, .95),
    hsla(${h+18}, 95%, 80%, .95)
  )`;
}

function render(){
  ui.poles.innerHTML = "";
  for(let i=0;i<3;i++){
    const pole = document.createElement("div");
    pole.className = "pole";
    pole.dataset.pole = String(i);

    const poleTop = document.createElement("div");
    poleTop.className = "poleTop";
    poleTop.innerHTML = `
      <div class="poleLabel">
        <span class="dot"></span>
        <span class="name">ç¬¬ ${i+1} æŸ±ï½œ${POLE_NAMES[i]}</span>
      </div>
      <div class="poleCount">${stacks[i].length} æš</div>
    `;

    const rod = document.createElement("div");
    rod.className = "rod";
    const base = document.createElement("div");
    base.className = "base";

    const stack = document.createElement("div");
    stack.className = "stack";

    for(const size of stacks[i]){
      const d = document.createElement("div");
      d.className = "disk" + (size<=2 ? " small": "");
      d.style.width = diskWidthPercent(size) + "%";
      d.style.background = diskBg(size);
      d.dataset.size = String(size);
      d.dataset.pole = String(i);

      const isTop = (size === stacks[i][stacks[i].length-1]);
      const isSelected = selected && selected.fromPole === i && selected.size === size && isTop;
      if(isSelected) d.classList.add("selected");

      const label = size===1 ? "æœ€å°ç¢ç‰‡" : (size===N ? "æœ€å¤§ç¢ç‰‡" : `ç¢ç‰‡-${size}`);
      d.innerHTML = `
        <div class="left">
          <div class="pin">ğŸ¦’</div>
          <div class="txt">é¹¿ç²‰å¾½ç« ï½œ${label}</div>
        </div>
        <div class="tag">${size}è™Ÿ</div>
      `;

      d.addEventListener("click",(e)=>{ e.stopPropagation(); onPoleTap(i); });
      stack.appendChild(d);
    }

    pole.appendChild(poleTop);
    pole.appendChild(rod);
    pole.appendChild(base);
    pole.appendChild(stack);

    pole.addEventListener("click", ()=> onPoleTap(i));
    ui.poles.appendChild(pole);
  }
}

function topDisk(poleIndex){
  const arr = stacks[poleIndex];
  return arr.length ? arr[arr.length-1] : null;
}
function canPlace(size, poleIndex){
  const top = topDisk(poleIndex);
  if(top === null) return true;
  return size < top;
}

function onPoleTap(poleIndex){
  if(!selected){
    const size = topDisk(poleIndex);
    if(size === null){
      toast("é€™æ ¹æŸ±å­ç›®å‰ç©ºç©ºçš„ï½");
      return;
    }
    selected = { fromPole: poleIndex, size };
    ui.selectInfo.textContent = `å·²æ‹¿èµ·ï¼š${size}è™Ÿï¼ˆ${POLE_NAMES[poleIndex]}ï¼‰`;
    popSfx("pick");
    render();
    return;
  }

  const { fromPole, size } = selected;
  if(poleIndex === fromPole){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  if(!canPlace(size, poleIndex)){
    toast("è¦å‰‡ï¼šå°å¾½ç« æ‰èƒ½æ”¾åœ¨å¤§å¾½ç« ä¸Šï¼");
    popSfx("bad");
    return;
  }

  const fromArr = stacks[fromPole];
  const actual = fromArr[fromArr.length-1];
  if(actual !== size){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  fromArr.pop();
  stacks[poleIndex].push(size);

  moves += 1;
  ui.moves.textContent = String(moves);
  selected = null;
  ui.selectInfo.textContent = "æœªé¸å–";
  popSfx("drop");
  render();

  checkWin();
}

function checkWin(){
  if(stacks[2].length !== N) return;

  stopTimer();
  ui.overlayWin.classList.add("show");

  const theoretical = minMovesFor(N);
  const rank = moves === theoretical ? "å®Œç¾é¹¿ç²‰ï¼" : (moves <= theoretical + 8 ? "ç¥ç´šé¹¿ç²‰ï¼" : "åˆæ ¼é¹¿ç²‰ï¼");
  ui.winText.textContent =
    `ä½ ç”¨ ${moves} æ­¥ã€${fmtTime(elapsedSec)} æŠŠç¢ç‰‡å¾½ç« å…¨é€åˆ°ã€Œå¤©ç©ºè£‚ç¸«æŸ±ã€âœ¨` +
    `\n${rank}ï¼ˆç†è«–æœ€å°‘ï¼š${theoretical} æ­¥ï¼‰`;

  ui.kpiMoves.textContent = String(moves);
  ui.kpiTime.textContent = fmtTime(elapsedSec);

  const b = getBest(N);
  let isNew = false;
  if(!b || !isFinite(b.bestMoves) || !isFinite(b.bestTimeSec)){
    setBest(N, moves, elapsedSec);
    isNew = true;
  }else{
    const better = (moves < b.bestMoves) || (moves === b.bestMoves && elapsedSec < b.bestTimeSec);
    if(better){ setBest(N, moves, elapsedSec); isNew = true; }
  }
  const nb = getBest(N);
  ui.kpiBest.textContent = nb ? `${nb.bestMoves} / ${fmtTime(nb.bestTimeSec)}` : "â€”";
  renderBest();

  if(isNew) toast("ğŸ† æ–°æœ€ä½³ç´€éŒ„ï¼é¹¿é¹¿é»é ­ä¸­");
}

function showHow(){
  alert(
`ã€é¹¿é¹¿æ¬é‹ä»»å‹™ï½œç©æ³•ã€‘
1) é»ä¸€ä¸‹æŸ±å­ï¼šæ‹¿èµ·è©²æŸ±æœ€ä¸Šå±¤ã€Œé¹¿ç²‰å¾½ç« ã€
2) å†é»ç›®æ¨™æŸ±ï¼šæŠŠå¾½ç« æ”¾ä¸‹

è¦å‰‡ï¼šå°å¾½ç« æ‰èƒ½æ”¾åœ¨å¤§å¾½ç« ä¸Š
ç›®æ¨™ï¼šæŠŠå…¨éƒ¨ ${N} æšå¾½ç« æ¬åˆ°ç¬¬ 3 æŸ±ï¼ˆå¤©ç©ºè£‚ç¸«æŸ±ï¼‰`
  );
}

async function initLIFF(){
  // TODOï¼šéƒ¨ç½²å¾Œæ›æˆä½ çš„ LIFF ID
  const LIFF_ID = "2008836744-mte99j4K";

  const inLineUA = /Line/i.test(navigator.userAgent);

  try{
    if(window.liff && LIFF_ID && LIFF_ID !== "PUT_YOUR_LIFF_ID_HERE"){
      await liff.init({ liffId: LIFF_ID });
      ui.modeBadge.textContent = liff.isInClient() ? "LINE" : "WEB";
      if(liff.isLoggedIn()){
        const p = await liff.getProfile();
        ui.userLine.textContent = `Hi ${p.displayName}ï½œé¹¿ç²‰è«‹å°±ä½ ğŸ¦’âœ¨`;
      }else{
        ui.userLine.textContent = "æœªç™»å…¥ï¼ˆä»å¯ç›´æ¥ç©ï¼‰";
      }
    }else{
      ui.modeBadge.textContent = inLineUA ? "LINE" : "WEB";
      ui.userLine.textContent = inLineUA ? "åœ¨ LINE å…§é–‹å•Ÿ âœ…ï¼ˆéƒ¨ç½²å¾Œå¯é¡¯ç¤ºåç¨±ï¼‰" : "ä¸€èˆ¬ç€è¦½å™¨æ¨¡å¼";
    }
  }catch{
    ui.modeBadge.textContent = "WEB";
    ui.userLine.textContent = "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œä½†ä»å¯éŠç©";
  }
}

function closeWindow(){
  if(window.liff && liff.isInClient && liff.isInClient()){
    liff.closeWindow();
  }else{
    toast("é LINE å…§ï¼Œç„¡æ³•è‡ªå‹•é—œé–‰");
  }
}

async function shareResult(){
  const text = `ğŸ¦’âœ¨ æˆ‘å‰›åœ¨ã€Œé¹¿é¹¿æ¬é‹ä»»å‹™ï¼ˆ${N} æšï¼‰ã€ç”¨ ${moves} æ­¥ã€${fmtTime(elapsedSec)} é€šé—œï¼é¹¿ç²‰å ±åˆ°ï½`;
  try{
    if(window.liff && liff.isApiAvailable && liff.isApiAvailable("shareTargetPicker")){
      await liff.shareTargetPicker([{ type:"text", text }]);
      toast("å·²å‘¼å«åˆ†äº«");
    }else{
      await navigator.clipboard.writeText(text);
      toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
    }
  }catch{
    try{ prompt("è¤‡è£½åˆ†äº«æ–‡å­—ï¼š", text); }catch{}
  }
}

/** Events */
ui.btnHow.addEventListener("click", showHow);
ui.btnSound.addEventListener("click", ()=>{
  soundOn = !soundOn;
  ui.btnSound.textContent = `éŸ³æ•ˆï¼š${soundOn ? "é–‹" : "é—œ"}`;
  if(soundOn) popSfx("pick");
});
ui.btnRestart.addEventListener("click", ()=> resetGame(N));
ui.btnClose.addEventListener("click", closeWindow);
ui.btnNew.addEventListener("click", ()=> resetGame(parseInt(ui.level.value,10)));
ui.btnNext.addEventListener("click", ()=>{
  ui.overlayWin.classList.remove("show");
  const next = Math.min(8, N + 1);
  ui.level.value = String(next);
  resetGame(next);
});
ui.btnShare.addEventListener("click", shareResult);

/** Start */
(async function main(){
  await initLIFF();
  renderBest();
  resetGame(N);
})();
</script>
</body>
</html>
